{
  "info": {
    "name": "API-03 Change Password Test Cases",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:8091" },
    { "key": "token", "value": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwOTEvdXNlcnMvbG9naW4iLCJpYXQiOjE3NTYwMTEwNjksImV4cCI6MTc3MTYxMTA2OSwibmJmIjoxNzU2MDExMDY5LCJqdGkiOiJJRzY5bkhwNUl0OWJHVUZaIiwic3ViIjoiMSIsInBydiI6IjIzYmQ1Yzg5NDlmNjAwYWRiMzllNzAxYzQwMDg3MmRiN2E1OTc2ZjciLCJyb2xlIjoiYWRtaW4ifQ.XHMrYL58F0_z1sXct4nr9FRK8gQUNIfSDpgxZlRMeaA" },
    { "key": "baseline_password", "value": "welcome01" }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
        { "key": "token", "value": "{{token}}", "type": "string" }
    ]
 },
  "event": [
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "pm.test('No 5xx', () => pm.expect(pm.response.code).to.not.be.within(500,599));"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "TC01 - Happy Path",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}"
        }
      },
      "event": [{
        "listen": "test",
        "script": {
          "type": "text/javascript",
            "exec": [
              "function safeJson(){ try { return pm.response.json(); } catch(e){ return null; } }",
              "function getNewPwd(){ try { return JSON.parse(pm.request.body.raw).new_password; } catch(e){ return null; } }",
              "",
              "pm.test('Status 200', function(){ pm.response.to.have.status(200); });",
              "var j = safeJson();",
              "pm.test('success === true', function(){ pm.expect(j && j.success).to.eql(true); });",
              "",
              "var ok = pm.response.code === 200 && j && j.success === true;",
              "if (!ok) { return; }",
              "",
              "// === Teardown: reset về baseline ===",
              "var baseUrl    = pm.variables.get('baseUrl');",
              "var oldToken   = pm.variables.get('token');",
              "var baseline   = pm.environment.get('baseline_password');",
              "var newPwd     = getNewPwd();",
              "var loginEmail = pm.environment.get('login_email');",
              "",
              "function findToken(obj){",
              "  if (!obj || typeof obj !== 'object') return null;",
              "  if (typeof obj.token === 'string') return obj.token;",
              "  if (typeof obj.access_token === 'string') return obj.access_token;",
              "  if (obj.authorization && typeof obj.authorization.token === 'string') return obj.authorization.token;",
              "  if (obj.data){",
              "    var t = findToken(obj.data); if (t) return t;",
              "    if (typeof obj.data.access_token === 'string') return obj.data.access_token;",
              "    if (typeof obj.data.token === 'string') return obj.data.token;",
              "  }",
              "  for (var k in obj){",
              "    if (!Object.prototype.hasOwnProperty.call(obj,k)) continue;",
              "    var v = obj[k];",
              "    if (typeof v === 'string' && /(^|_)token$|^jwt$|^id_token$/.test(k)) return v;",
              "    if (v && typeof v === 'object'){ var r = findToken(v); if (r) return r; }",
              "  }",
              "  return null;",
              "}",
              "",
              "function resetWith(tokenToUse){",
              "  pm.sendRequest({",
              "    url: baseUrl + '/users/change-password',",
              "    method: 'POST',",
              "    header: { Authorization: 'Bearer ' + tokenToUse, 'Content-Type': 'application/json' },",
              "    body: { mode: 'raw', raw: JSON.stringify({",
              "      current_password: newPwd,",
              "      new_password: baseline,",
              "      new_password_confirmation: baseline",
              "    }) }",
              "  }, function (err, res) {",
              "    if (res && (res.code === 200 || res.code === 204)) {",
              "      pm.test('Reset back to baseline', function(){ pm.expect([200,204]).to.include(res.code); });",
              "      return;",
              "    }",
              "    pm.sendRequest({",
              "      url: baseUrl + '/users/login',",
              "      method: 'POST',",
              "      header: { 'Content-Type': 'application/json', 'Accept': 'application/json' },",
              "      body: { mode: 'raw', raw: JSON.stringify({ email: loginEmail, password: newPwd }) }",
              "    }, function (e2, r2) {",
              "      var lj = null; try { lj = r2 && r2.json ? r2.json() : null; } catch(e){}",
              "      var freshToken = findToken(lj);",
              "      if (!freshToken) {",
              "        console.log('Re-login response code:', r2 && r2.code, 'body:', lj);",
              "        pm.test('Re-login skipped (no token in response)', function(){ pm.expect(true).to.eql(true); });",
              "        return;",
              "      }",
              "      pm.sendRequest({",
              "        url: baseUrl + '/users/change-password',",
              "        method: 'POST',",
              "        header: { Authorization: 'Bearer ' + freshToken, 'Content-Type': 'application/json' },",
              "        body: { mode: 'raw', raw: JSON.stringify({",
              "          current_password: newPwd,",
              "          new_password: baseline,",
              "          new_password_confirmation: baseline",
              "        }) }",
              "      }, function (e3, r3) {",
              "        pm.test('Reset back to baseline', function(){ pm.expect([200,204]).to.include(r3 && r3.code); });",
              "      });",
              "    });",
              "  });",
              "}",
              "",
              "if (newPwd && newPwd !== baseline) {",
              "  resetWith(oldToken);",
              "}"
            ]
        }
      }]
    },

    {
      "name": "TC02 - Min Length Password (8 chars)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Abcde123\",\"new_password_confirmation\":\"Abcde123\"}"
        }
      }
    },

    {
      "name": "TC03 - Password Too Short (7 chars)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Abcd123\",\"new_password_confirmation\":\"Abcd123\"}"
        }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": ["pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));"] }
      }]
    },

    {
      "name": "TC05 - Max Length Password (64 chars)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"new_password_confirmation\":\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}"
        }
      }
    },

    {
      "name": "TC06 - Password Exceeds Max Length (65 chars)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"new_password_confirmation\":\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}"
        }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": ["pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));"] }
      }]
    },

    {
      "name": "TC08 - Password and Confirmation Mismatch",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Aa123456!\",\"new_password_confirmation\":\"aa123456!\"}"
        }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": ["pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));"] }
      }]
    },

    {
      "name": "TC09 - Missing current_password",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      }
    },

    {
      "name": "TC10 - Missing new_password",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC11 - Missing new_password_confirmation",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC12 - Incorrect current_password",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"wrong\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC13 - new_password identical to current_password (reject)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"welcome01\",\"new_password_confirmation\":\"welcome01\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC14 - Leading/trailing whitespaces in new_password",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"  Welcome02!  \",\"new_password_confirmation\":\"  Welcome02!  \"}" }
      },
      "event": [{
        "listen": "test",
        "script": {
          "type": "text/javascript",
          "exec": [
            "pm.test('Status 200 or 400 (trim policy)', ()=> pm.expect([200,400,422]).to.include(pm.response.code));"
          ]
        }
      }]
    },
    {
      "name": "TC15 - Unicode characters in new_password",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Mậtkhẩu123!\",\"new_password_confirmation\":\"Mậtkhẩu123!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": {
          "type": "text/javascript",
          "exec": [
            "pm.test('Unicode allowed per policy (200/400/422)', ()=> pm.expect([200,400,422]).to.include(pm.response.code));"
          ]
        }
      }]
    },
    {
      "name": "TC16 - Alphanumeric-only new_password (likely reject by policy)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Abcdef12\",\"new_password_confirmation\":\"Abcdef12\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 200/400/422 (policy-dependent)', ()=> pm.expect([200,400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC17 - Special-characters-only new_password (likely reject)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"!@#$%^&*()\",\"new_password_confirmation\":\"!@#$%^&*()\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/422/200 (policy-dependent)', ()=> pm.expect([400,422,200]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC18 - Extra unexpected field in body (should ignore)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\",\"note\":\"abc\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 200 or 400 (ignore/validate)', ()=> pm.expect([200,400]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC19 - Accept header text/plain (not supported -> 406)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Accept", "value": "text/plain" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400 (or 200 if server ignores Accept)', ()=> pm.expect([400,200]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC20 - Missing Authorization header (401)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400', ()=> pm.expect(pm.response.code).to.eql(400));" ] }
      }]
    },
    {
      "name": "TC21 - Invalid/expired token (401)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer invalid" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400', ()=> pm.expect(pm.response.code).to.eql(400));" ] }
      }]
    },
    {
      "name": "TC22 - Missing Content-Type header (415/400)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 415/400', ()=> pm.expect([415,400]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC23 - Wrong Content-Type (text/plain -> 415)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "text/plain" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400', ()=> pm.expect(pm.response.code).to.eql(400));" ] }
      }]
    },
    {
      "name": "TC24 - Accept header application/xml (not supported -> 406)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Accept", "value": "application/xml" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400 (or 200 if server ignores Accept)', ()=> pm.expect([400,200]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC25 - Malformed JSON in body (400)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"a\"" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400', ()=> pm.expect(pm.response.code).to.eql(400));" ] }
      }]
    },
    {
      "name": "TC26 - SQL injection in current_password (reject)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"abc' OR '1'='1\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": {
          "type": "text/javascript",
          "exec": [
            "pm.test('Status 400/422 (no 5xx)', ()=> { pm.expect([400,422]).to.include(pm.response.code); });"
          ]
        }
      }]
    },
    {
      "name": "TC27 - XSS attempt in new_password (reject)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"<script>alert(1)</script>\",\"new_password_confirmation\":\"<script>alert(1)</script>\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/422', ()=> pm.expect([400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC28 - Null byte injection in new_password",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"Pass\\u0000word123!\",\"new_password_confirmation\":\"Pass\\u0000word123!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 200/400/422 (policy-dependent)', ()=> pm.expect([200,400,422]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC29 - Content-Type and body mismatch (-> 400/415)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "message=hi" }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/415 (not 200)', ()=> { pm.expect([400,415]).to.include(pm.response.code); pm.expect(pm.response.code).to.not.eql(200); });" ] }
      }]
    },
    {
      "name": "TC30 - Excessively long password (300 chars -> 400/413)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": {
          "mode": "raw",
          "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\",\"new_password_confirmation\":\"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}"
        }
      },
      "event": [{
        "listen": "test",
        "script": { "type": "text/javascript", "exec": [ "pm.test('Status 400/413', ()=> pm.expect([400,413]).to.include(pm.response.code));" ] }
      }]
    },
    {
      "name": "TC31 - Rate limiting/lockout after repeated invalid attempts",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" },
          { "key": "Content-Type", "value": "application/json" }
        ],
        "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
        "body": { "mode": "raw", "raw": "{\"current_password\":\"wrong\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
      },
      "event": [{
        "listen": "test",
        "script": {
          "type": "text/javascript",
          "exec": [
            "const baseUrl = pm.variables.get('baseUrl');",
            "const token = pm.variables.get('token');",
            "const attempts = 6;",
            "let done = 0, locked = false;",
            "for (let i=0;i<attempts;i++){",
            "  pm.sendRequest({",
            "    url: baseUrl + '/users/change-password',",
            "    method: 'POST',",
            "    header: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },",
            "    body: { mode:'raw', raw: JSON.stringify({ current_password:'wrong', new_password:'Welcome02!', new_password_confirmation:'Welcome02!' }) }",
            "  }, (err,res)=>{",
            "    done++;",
            "    if ([429,401,403].includes(res && res.code)) locked = true;",
            "    if (done===attempts){ pm.test('Lockout / rate limit engaged', ()=> pm.expect(locked).to.eql(true)); }",
            "  });",
            "}"
          ]
        }
      }]
    },
    {
    "name": "TC32 - All fields empty",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"\",\"new_password\":\"\",\"new_password_confirmation\":\"\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (all fields required)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  },
  {
    "name": "TC33 - Case sensitivity mismatch (new_password vs confirmation)",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"welcome02!\",\"new_password_confirmation\":\"WELCOME02!\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (mismatch)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  },
  {
    "name": "TC34 - New password identical to current (reuse not allowed)",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}\",\"new_password\":\"{{baseline_password}}\",\"new_password_confirmation\":\"{{baseline_password}}\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (password reuse forbidden)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  },
  {
    "name": "TC35 - SQLi tautology in current_password (' OR 1=1 --)",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"' OR 1=1 --\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (reject SQLi tautology)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  },
  {
    "name": "TC36 - SQLi UNION-based in current_password",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"' UNION SELECT null, null, null --\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (reject UNION injection)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  },
  {
    "name": "TC37 - SQLi stacked queries in current_password ('; DROP ...)",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"'; DROP TABLE users; --\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (reject stacked queries)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  },
  {
    "name": "TC38 - SQLi comment injection in current_password (/* ... */)",
    "request": {
      "method": "POST",
      "header": [
        { "key": "Authorization", "value": "Bearer {{token}}" },
        { "key": "Content-Type", "value": "application/json" }
      ],
      "url": { "raw": "{{baseUrl}}/users/change-password", "host": ["{{baseUrl}}"], "path": ["users","change-password"] },
      "body": { "mode": "raw", "raw": "{\"current_password\":\"{{baseline_password}}'/*test*/\",\"new_password\":\"Welcome02!\",\"new_password_confirmation\":\"Welcome02!\"}" }
    },
    "event": [{
      "listen": "test",
      "script": { "type": "text/javascript", "exec": [
        "pm.test('Status 400/422 (reject comment injection)', ()=> pm.expect([400,422]).to.include(pm.response.code));"
      ] }
    }]
  }
  ]
}
